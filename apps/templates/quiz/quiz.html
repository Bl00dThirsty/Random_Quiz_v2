{% extends "layouts/base.html" %}
{% load static %}

{% block title %}  Quiz{% endblock %} 

<!-- Specific Page CSS goes HERE--><link rel="stylesheet" href="{% static 'assets/css/quiz.css' %}">  
{% block stylesheets %}
{{ block.super }}

{% endblock stylesheets %}


{% block content %}
  <div id="app">
    <main class="main">
      <div class="container">
        <section class="quiz-section">
          <div class="timer">
            <div class="progress">
              <div class="progress-bar">
                <span class="progress-text">temps</span>
                <span class="progress-text"><!-- <p>Score total: {{ score }}</p>--></span>
              </div>
            </div>
          </div>
          <div class="quiz-box">
            <h1>sai lama quiz</h1>
              <p>[[currentQuestion.question]]</p>
              <div class="answer-wrapper">
                <div class="form-check" v-for="answer in currentQuestion.answers" @change="checkAnswer($event, currentQuestion.uid)" :value="answer.answer"  :id="answer.id">
                  [[answer.answer]]
                </div>
              </div>
              <div class="quiz-footer">
                <span class="question-total">1 sur 10 questions</span>
                <button @click="nextQuestion" class="next-btn">Suivant</button>
              </div>
          </div>

            <div class="result-box">
            <h2>RÃ©sultat du test!</h2>
            <div class="percentage-container">
                <div class="cicular-progress">
                    <span class="progress-value">0%</span>
                </div>
    
                <span class="score-text">Votre score est de {{ score }} sur 10</span>
            </div>
    
            <div class="buttons">
                <button class="TryAgain-btn">Reessayer</button>
                <button class="goHome-btn">Acceuil</button>
            </div>
            </div>
        </section>
      </div>
    </main>
  </div>
      
  {% endblock %}
    
    
    
   


    {% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    
<script>
const result_box = document.querySelector(".result-box");
    var app = new Vue({
      el: '#app',
      delimiters: ['[[', ']]'],
      data() {
        return {
          category: '{{category}}',
          questions: [],
          currentQuestion: null,
        };
      },
      methods: {
        getQuestions() {
            var _this = this;
            return fetch(`/api/get-quiz/?category=${this.category}`)
                .then(response => response.json())
                .then(result => {
                console.log(result);
                _this.questions = result.data;
                if (_this.questions.length > 0) {
                    _this.currentQuestion = _this.questions[0];
                }
                });
            },
        
        checkAnswer(event, uid) {
          this.questions.forEach(question => {
            if (question.uid === uid && !question.answered) {
              question.answered = true;
              const selectedAnswer = question.answers.find(answer => answer.answer === event.target.value);
              if (selectedAnswer) {
                if (selectedAnswer.is_correct) {
                  console.log('reponse juste');
                  alert('hurrrr correcte');
                } else {
                  console.log('reponse fausse');
                }
              }
            }
          });
        },
        showResultBox() {
            quizBox.classList.remove('active');
            result_box.classList.add('active');

            const score_text = document.querySelector('.score-text');
            score_text.textContent = `Votre score est de ${userScore} sur ${questions.length}`;

            if(userScore < 5){
                TryAgain.classList.add('active');
            }
            else{
                TryAgain.classList.remove('active');
            }



            const circularProgress = document.querySelector('.cicular-progress');
            const progressValue = document.querySelector('.progress-value');

            let progressStartValue = -1;
            let progressEndValue = (userScore / questions.length) * 100;
            let speed = 20;

            let progress = setInterval(() => {
                progressStartValue++;
                //console.log(progressStartValue);
                progressValue.textContent = `${progressStartValue}%`;
                circularProgress.style.background = `conic-gradient(#c40094 ${progressStartValue * 3.6}deg, rgba(255, 255, 255, .1) 0deg)`;


                if (progressStartValue == progressEndValue) {

                    clearInterval(progress);

                }

            }, speed);
        },
        nextQuestion() {
            const currentIndex = this.questions.indexOf(this.currentQuestion);
            const nextIndex = currentIndex + 1;
            if (nextIndex < this.questions.length) {
            this.currentQuestion = this.questions[nextIndex];
            }
            else {
            this.showResultBox();
            }
        },
        
      },
      created() {
        this.getQuestions();
      }
    });



</script>
  {% endblock javascripts %}
